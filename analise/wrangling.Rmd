---
title: "Análise Descritiva e exploratória"
author: "Luiz Alberto Fonseca"
date: "August 30, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# libraries
library(plyr)
library(tidyverse)
library(ggplot2)
```


```{r}
# Read files from one folder and bind them together into one df

data_directory_path = "testData"

filenames <- list.files(data_directory_path, pattern="*.csv", full.names=TRUE)
list_of_dataframes <- lapply(filenames, read.csv)
busData <- rbind.fill(list_of_dataframes)
```

Primeiramente, vamos ver as variáveis que existem nos dados:

```{r}
str(busData)
```

Podemos ver que existem 37 variáveis, onde temos:
* route                    : rota do ônibus
* tripNumOrig              : o número da viagem do ônibus na origem
* shapeId                  : o id do shape do ônibus
* shapeSequence            : o ponto do shape que a viagem está atualmente
* shapeLatOrig             : a latitude da origem do shape
* shapeLonOrig             : a longitude da origem do shape
* distanceTraveledShapeOrig: a distancia que o ônibus já viajou na origem.
* busCode                  : o código do ônibus
* gpsPointId               : o id do ponto do gps
* gpsLat                   : a latitude do ponto do gps
* gpsLon                   : a longitude do ponto do gps
* distanceToShapePoint     : a distância do gps para o ponto do shape casado
* timestampOrig            : o horário no ponto de origem
* busStopIdOrig            : a parada do ônibus no ponto de origem
* problem                  : o tipo de problema encontrado pelo BULMA que pode ser NO_PROBLEM, quando não houver problema, NO_SHAPE, quando nenhuma trip foi formada (gps sem shape na base de dados ou com pontos insuficientes para formar trip), TRIP_PROBLEM, quando não foi possível identificar ponto final/ponto inicial, OUTLIER_POINT, quando os pontos excederam o threshold de distância para o shape.
* date                     : a data da viagem
* busStopIdDest            : o ponto de ônibus do destino
* timestampDest            : o horário no ponto de destino
* tripNumDest              : o número da viagem do ônibus no destino
* shapeLatDest             : a latitude do ponto do shape destino
* shapeLonDest             : a longitude do ponto do shape destino
* distanceTraveledShapeDest: a distancia que o ônibus já viajou no destino
* duration                 : a duração entre a parada origem e destino
* distance                 : a distancia entre a parada origem e destino
* hourOrig                 : a hora de origem
* hourDest                 : a hora de destino
* isRushOrig               : indicativo se está em horário de pico na origem
* isRushDest               : indicativo se está me horário de pico no destino
* periodOrig               : o período na origem (manhã, tarde, noite)
* periodDest               : o período no destino (manhã, tarde, noite)
* weekDay                  : o dia da semana
* weekOfYear               : a semana do ano
* dayOfMonth               : o dia do mês
* month                    : o mês
* isHoliday                : indicativo se está em mês de férias
* isWeekend                : indicativo se é final de semana
* isRegularDay             : indicativo se está entre a terça e quinta inclusive

Análises posssíveis:

2) um panorama das distâncias entre as paradas
3) um panorama do número de shapes por rota
4) um panorama do número de paradas por shape
5) um panorama do tamanho dos shapes
6) Relação entre duração entre uma parada e outra e a distância entre essas paradas
7) panorama do periodo do dia e duração da viagem entre duas paradas
8) Panorama entre o dia da semana e a duração da viagem entre duas paradas

analises que queremos:

1) Relação entre a hora do dia e duração de uma viagem entre duas paradas
2) Relação entre o dia da semana e a duração de uma viagem entre duas paradas
3) Relação entre a área da cidade e a duração de uma viagem entre duas paradas

## Hora do dia
Agora vamos plotar um gráfico de duração de viagens entre paradas por horas do dia.
```{r}
p <- ggplot(busData, aes(x = as.factor(hourOrig), y = duration, colour = problem))
p + geom_jitter(aes(alpha = 0.5))
```

Problemas encontrados:

1) Algumas durações estão negativas (pouquíssimos casos 8 em 190 mil da amostra).
2) Algumas durações estão muito longas. Muitos desses casos ocorrem quando o número de viagem da origem é diferente do número de viagem do destino.

Há um problema de cálculo no preprocessamento quando a parada de origem é a última parada do shape e a parada de destino é a primeira parada do shape.
Filtrando esses casos obtemos o gŕafico abaixo.

```{r}
temp <- busData %>% filter(distanceTraveledShapeDest > 0)

p <- ggplot(temp, aes(x = as.factor(hourOrig), y = duration, colour = problem))
p + geom_jitter(aes(alpha = 0.5))
```

Há casos em que o número da viagem do ponto de origem e o número da viagem do ponto de destino não são iguais (nem consecutivos?).
Filtrando esses casos obtemos o gŕafico abaixo.

```{r}
temp2 <- temp %>% filter(abs(tripNumOrig - tripNumDest) == 0)

p <- ggplot(temp2, aes(x = as.factor(hourOrig), y = duration, colour = problem))
p + geom_jitter(aes(alpha = 0.5))
```

Não é interessante que haja casos em que a parada de origem é igual à parada de destino. Vamos filtrar esses casos e visualizar como ficam os dados.

```{r}
temp3 <- temp2 %>% filter(busStopIdOrig != busStopIdDest)

p <- ggplot(temp3, aes(x = as.factor(hourOrig), y = duration, colour = problem))
p + geom_jitter(aes(alpha = 0.5))
```

Não mudou muita coisa.
Há casos em que simplesmente o ônibus demorou muito para ir de uma parada a outra e não se sabe exatamente o porquê.

Podemos calcular a velocidade média do ônibus para ir de uma parada a outra. O resultado está no gráfico abaixo.

```{r}
temp3 <- temp3 %>% mutate(velocityKmh = ((distance / duration) * 3.6))

p <- ggplot(temp3, aes(x = "velocidade", y = velocityKmh, colour = problem))
p + geom_jitter(aes(alpha = 0.5))
```

Às vezes a velocidade é infinita (quando a duração é 0).
Há muitas velocidades que não fazem sentido para um ônibus. 
A velocidade máxima para ônibus em trechos urbanos é de 90 km/h.

```{r}
# Filtrando velocidades irreais (muito altas)
temp4 <- temp3 %>% filter(velocityKmh <= 90)

# filtrando viagens sem problemas e interpoladas
temp5 <- temp4 %>% filter(problem %in% c("NO_PROBLEM", "BETWEEN"))

p <- ggplot(temp5, aes(x = "velocidade", y = velocityKmh))
p + geom_jitter(aes(alpha = 0.5, colour = problem))

p + geom_boxplot(aes(colour="red"))
```

É possível perceber que cerca de 75% das observações tem velocidade abaixo de 35 km/h, sendo a mediana próxima de 25 km/k.

```{r}
p <- ggplot(temp5, aes(x = as.factor(hourOrig), y = duration, colour = problem))
p + geom_jitter(aes(alpha = 0.5))
```

É notório que existem alguns outliers na visualização acima. 

Vamos ver um ponto de corte aceitável para a duração:

```{r}
percentiles <- data.frame(perc = seq(0, 1, 0.0001))

percentiles <- percentiles %>% 
  mutate(
    value = quantile(temp5$duration, perc),
    diff = value - lag(value)     
         )

ggplot(percentiles, aes(x = perc, y = value)) +
  geom_line()
```

Podemos ver que os dados estão bem concentrados até certo ponto, então vejamos as últimas observações para descobrirmos um bom ponto de corte de outliers:

```{r}
percentiles %>% 
  arrange(-perc) %>% 
  head(50)
```

Podemos ver que a diferença entre os valores dos percentis, os quais aumentam em 0.001 a cada linha, começam a aumentar repentinamente a partir do percentil 0.9984. Com isso, vamos estabelecer que a duração é um outlier quando for maior que 1100 segundos.

Vamos verificar se este ponto de corte de duração faz sentido em relação ao geral:

```{r}
threshold <- 1100
temp5 %>% 
  ggplot(aes(y = duration, x = problem, colour=problem)) +
  geom_jitter(aes(alpha = 0.5)) +
  geom_violin() +
  geom_hline(yintercept = threshold)
```

Podemos perceber que no geral, as durações acima do ponto de corte estão bem dispersas, enquanto as que estão abaixo são mais concentradas.

Com isso, vamos filtrar as observações que tem a duração menor que o limiar.

```{r}
temp6 <- temp5 %>% filter(duration <= threshold)

p <- ggplot(temp6, aes(x = as.factor(hourOrig), y = duration))
p + geom_jitter(aes(alpha = 0.5, colour = problem))

p + geom_boxplot()
```

Vemos que alguns pontos ainda estão dispersos, mas estão bem mais concentrados do que antes do corte.

Além disso, podemos ver que entre as 7 e 18 horas a duração das viagens entre paradas são bastante parecidas, enquanto as demais tem valores mais baixos.
 
```{r}
write.csv(x = temp6, file = "dadostratados.csv", row.names = F)
```
